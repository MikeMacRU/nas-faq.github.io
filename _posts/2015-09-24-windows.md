---
layout: page
title:  Windows
categories: software
permalink: /software/windows/
---

## Платформа: Windows Server 2012

В новой редакции своей серверной ОС, Microsoft внесла множество улучшений в подсистемы,
критически важные для функционирования NAS.

Это новая подсистема, абстрагирующая физические диски от логического построения системы хранения данных,
новая файловая система, реализующая современные требования к масштабируемости и отказоустойчивости,
а также новая версия сетевого протокола, обеспечивающая несколько путей для канала передачи данных.

Все вместе это выводит NAS на платформе Windows server на новый уровень.

**На данный момент существует проблема катастрофически низкой скорости записи на пространства с четностью**

Используемые технологии: ReFS + Storage spaces + SMB3

## ReFS: Новая файловая система.

http://blogs.msdn.com/b/b8_ru/archive/2012/01/20/windows-refs.aspx

Контрольные суммы для данных записываются, считываются и сравниваются только при включенной функции
"целостные потоки (integrity streams)".

Integrity можно включать и отключать явно для объектов ФС вплоть до файлов (командлет Set-FileIntegrity).
При включении все изменения записываются отдельными блоками, оставляя оригинальные блоки
нетронутыми (copy on write), что не допускает порчи оригинального объекта при сбое.
По умолчанию integrity включена только для томов ReFS, находящихся на зеркальном пространстве.


## Storage spaces: Подсистема виртуализации СХД

http://blogs.msdn.com/b/b8_ru/archive/2012/01/13/10256577.aspx

Виртуализация СХД не эксклюзивна для Windows и уже используется в решениях различных вендоров (например HP).

Принцип работы следующий: HDD выделяются в пулы хранения.
В этих пулах создаются пространства хранения с заданными конфигурациями избыточности.
Система виртуализации СХД выделяет место на физических жестких дисках и раздает их
пространствам хранения так, что бы обеспечить заданную конфигурацию избыточности и
оптимальную производительность.

Таким образом, на каждом из жестких дисков одновременно могут находится данные разных
пространств хранения (например Mirror + Parity + Stripe).

Место выделяется большими блоками (например 256MB см. "размер пластин") по мере надобности,
т.е. пространства хранения могут иметь больший логический размер, чем физически доступно
системе (т.н. тонкая подготовка, thin provisioning).

### По сравнению с традиционными рейдами, технология виртуализации СХД дает следующие преимущества:

* Возможность простого добавления, замены, удаления физических дисков без полной пересборки пула.
* В пулах можно комбинировать диски разных размеров и типов, включая USB и iSCSI.
* Лучшую производительность, в случае конфигураций с разными уровнями избыточности,
так как пространства распределяются по большему кол-ву HDD, а не только по тем,
которые выделены для заданного уровня RAID.

### Возможные типы пространств в пуле:
* _Mirror_ - зеркало, можно задать кол-во копий
* _Simple_ - страйп
* _Parity_ - четность, на данный момент ограничена избыточностью в один диск.

Расширенные функции при создании и конфигурировании пространств, в том числе задание кол-во копий,
конкретное указание используемых дисков, выделение дисков для журнала и пр. доступны через PowerShell

Прочее:

* Пространства хранения представляются в системе как виртуальные диски.
Их можно расширять (возможности сужения видимо нет).
* Файловую систему на этом диске можно расширять и сужать стандартными средствами.
* Пространство не привязано к определенной ФС. Например при использовании NTFS пропадают
возможности ReFS но появляются дедубликация и квоты.
* Информация о пуле хранится на дисках пула. Соответственно его можно спокойно переносить
между компьютерами.
* После переноса пул активируется автоматически как только активируется одно из пространств,
которое в свою очередь активируется автоматически при обнаружении достаточного числа дисков для кворума.

## SMB3: Новая версия сетевого протокола Windows

http://blogs.technet.com/b/windowsserver/archive/2012/04/19/smb-2-2-is-now-smb-3-0.aspx

Основное достоинство новой SMB использование нескольких TCP-соединений внутри одной сессии,
что позволяет практически линейно увеличивать пропускную способность при физическом расширении канала.

[Источник](http://forum.ixbt.com/topic.cgi?id=11:44215:4103#4101)

## Windows 2012. Тесты Storage Spaces + ReFS (от Krey)
### Ссылки
*   [Дисковые пространства: программный RAID в Windows 8](http://www.ixbt.com/soft/windows-8-storage-spaces.shtml).
*   [Опыт применения на производстве](http://forum.ixbt.com/topic.cgi?id=11:44629-143#4239). Очень стоит почитать!

### Источник
[Оригинальное сообщение в форуме](http://forum.ixbt.com/topic.cgi?id=11:44215:4103#4103)

### Результаты

#### Локальный тест Crystal DM на пространстве с чередованием (Atom D510, 4xWD5000AAKS)
![](http://fotkidepo.ru/photo/281121/42688GpkZMXTuwv/798374w.jpg)

#### Локальный тест Crystal DM на зеркальном пространстве (Atom D510, 4xWD5000AAKS)
![](http://fotkidepo.ru/photo/281121/42688GpkZMXTuwv/798372w.jpg)

#### Локальный тест Crystal DM на пространстве с четностью (Atom D510, 4xWD5000AAKS)
![](http://fotkidepo.ru/photo/281121/42688GpkZMXTuwv/798375w.jpg)

#### Локальный тест dd for Windows (Core i7, 16GB, 4xST3000DM001)
```
Stripe read 6 618 Mbytes for 10,15 seconds, 652,03 MB/s
Stripe write    30 000 Mbytes for 57,82 seconds, 518,88 MB/s

Mirror read 6 618 Mbytes for 23,33 seconds, 283,64 MB/s
Mirror write    30 000 Mbytes for 115,68 seconds, 259,34 MB/s

Parity read 6 618 Mbytes for 13,18 seconds, 502,02 MB/s
Parity write    30 000 Mbytes for 1 031,68 seconds, 29,08 MB/s
```

#### Копирование по SMB3 одного большого файла по сети из двух 1Gb линков

Из пространства с чередованием на Ram-диск клиента Windows 8

![](http://fotkidepo.ru/photo/281121/42688GpkZMXTuwv/798376w.jpg)
