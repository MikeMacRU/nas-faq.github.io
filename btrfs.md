---
layout: page
title:  BTRFS
categories: btrfs
permalink: /btrfs/
---

[Отдельный раздел](/btrfs/).

Файловая система, разрабатываемая Oracle для Linux "по мотивам" ZFS.

## Опыт построения хранилки с btrfs поверх <abbr title="Redundant Array of Inexpensive Disks">RAID </abbr>5

_Текст от первого лица авторства_ **BuDDiE**

У меня это произошло спонтанно ![](http://forum.ixbt.com/wink.gif) Собрал очередную машину для бэкапов на
Procase ES420-SATAII-B-0 (нравятся мне эти корпуса), поставил CentOS 5.8, воткнул десяток дисков
на 1.5ТБ, создал RAID-5: ```mdadm --create /dev/md8 -n 10 -l 5 /dev/sd[c-l]```.
6-й в моем случае избыточен, т.к. никогда не беру пачку дисков из одной партии и в подавляющем числе случаев
заменить вылетевший диск смогу в течении нескольких часов.

Решил попробовать BTRFS.
[Подключил](http://stan1slav.blogspot.com/2010/08/yum-oracle-enterprise-linux.html) репозиторий Oracle,
далее

```sh
yum upgrade
```

Установил UEK-ядро

```sh
yum install kernel-uek.x86_64
```

Перезагрузка.

Cобрал из исходников iptables (1.4.9-1, ибо в родном с _uek_ ядром не работает _conntrack_).

Cоздал ФС

```sh
mkfs.btrfs -d single -m single -L btrfs01 /dev/md8
```

Cоздал подразделы

```sh
btrfs su create /mnt/btrfs01/backup_user
```

Все работает. Дальнейшее расширение ФС добавлением дисков:

```sh
mdadm /dev/md8 --add /dev/sdm
mdadm /dev/md8 --grow -n 11
```

Тюнинг ```/proc/sys/dev/raid/speed_limit_*``` для сохранения оптимальных скорости решейпинга и скорости доступа к данным

```sh
btrfs fi resize max /mnt/btrfs01
```

Как-то так. Т.е. массив собирается mdadm-ом - получается блочное устройство, которое форматируется в нужную ФС.

Уже не на одном массиве расширял таким образом и RAID-5 и 6.
На одной из машин вообще начал с 4 дисков и дошел последовательно до 8.
Проблем нет.

Единственный нюанс - при выполнении критической секции (несколько секунд)
не должно быть активных операций внутри массива (типа ребилда или проверки),
если они идут (или _внезапно_ вылетит диск в соседнем массиве) - будет дедлок.

[Источник](http://forum.ixbt.com/topic.cgi?id=11:44215:2923#2923) (примерно страницу вниз-вверх идет обсуждение).
